<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: vue-bs-loader.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: vue-bs-loader.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const urlObj = new URL(import.meta.url)

const getGlobal = function() {
  if (typeof self !== 'undefined') { return self; }
  if (typeof window !== 'undefined') { return window; }
  if (typeof global !== 'undefined') { return global; }
  throw new Error('unable to locate global object');
};

const _global = getGlobal();
_global.global = _global;
global.ssrComponents = new Map();

/**
 * loadTwigComponent
 * @param pathWithOutExt {string}
 * @param urlAppend {string}
 * @return {Promise&lt;unknown>}
 */
global.loadTwigComponent = function(pathWithOutExt = '', urlAppend = '') {
  // let url = `/getscript?src=${pathWithOutExt}.twig${urlAppend}`
  // let key = pathWithOutExt + '.vue'
  // return new Promise(resolve => {
  //   import(url).then(res => {
  //     let content =  res.default
  //     resolve(content)
  //   })
  // })

  const url = urlObj.origin + `/getcontent?src=${pathWithOutExt}.twig${urlAppend}`;
  const key = pathWithOutExt + '.vue';
  return new Promise(resolve => {
    global.fetch(url).then(async res => {
      // console.log(res);
      if (res.ok) {
        const content = await res.text();
        // console.log('content', content)
        resolve(content);
      }
    });
  });
};

// window.loadTwigComponent('formbuild', '&amp;config_id=').then((res) => {
//   console.log('loadTwigComponent', res)
// })

const ModuleConfig = (function() {

  const configMap = new Map();
  return {
    global: {
      setConfig(data = {}) {
        if (!data.id) {
          console.error('need id');
        }
        configMap.set(data.id, data);
      },
    },
    createStore() {
      return {
        install(app) {
          console.log(app);
          app.config.globalProperties.$alConfig = {
            get(id) {
              if (configMap.has(id)) {
                return configMap.get(id);
              }
            },
          };
        },
      };
    },
  };
})();


export const moduleConfig = ModuleConfig.createStore();

export function initBsLoader(Vue) {
  const options = {

    moduleCache: {
      vue: Vue,
    },

    async getFile(url) {
      const { urlAppend = '' } = options.customConfig ? options.customConfig : {};
      delete options.customConfig;
      const urlObj = new URL('http://' + url);
      const p = urlObj.hostname.split('.').slice(0, -1).join('.');
      const key = p + '.twig';
      if (global.ssrComponents.has(key)) {
        return Promise.resolve(global.ssrComponents.get(key));
      }
      // if (url.endsWith('twig')) {
      //   const p = url.split('.').slice(0, -1).join('.')
      //   return window.loadTwigComponent(p)
      // }
      // return window.loadTwigComponent(url)
      return global.loadTwigComponent(p, urlAppend);
      // return window.fetch(`/getscript?src=${url}`).then(response => {
      //   return response.ok ? response.text() : Promise.reject(response)
      // });
    },

    addStyle(styleStr) {
      const style = document.createElement('style');
      style.textContent = styleStr;
      const ref = document.head.getElementsByTagName('style')[0] || null;
      document.head.insertBefore(style, ref);
    },

    customBlockHandler(block, filename, options) {

      if (block.type !== 'config') { return; }

      const messages = JSON.parse(block.content);
      // console.log(messages, filename, options)
      ModuleConfig.global.setConfig(messages);
    },

    log(type, ...args) {
      console.log(type, ...args);
    },
  };

  const { loadModule, version } = global['vue3-sfc-loader'];

  global.loadComponent = (path, urlAppend) => {
    options.customConfig = {
      urlAppend,
    };
    return Vue.defineAsyncComponent(() => loadModule(path, options));
  };
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#initFormBase">initFormBase</a></li><li><a href="global.html#initTemplate">initTemplate</a></li><li><a href="global.html#loadTemplate">loadTemplate</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Wed Jul 14 2021 19:46:15 GMT+0800 (中国标准时间)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
